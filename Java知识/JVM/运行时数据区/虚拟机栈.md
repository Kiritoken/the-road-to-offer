# 虚拟机栈

栈是运行时的单位，堆时存储的单位

java虚拟机栈（Java Virtual Machine Stack），早期也叫Java栈。


每个线程在创建时都会创建一个虚拟机栈，其内部保存一个个的栈帧（Stack Frame），对应这个一次次的java方法调用。它是线程私有的


生命周期和线程是一致的


作用：主管java程序的运行，它保存方法的局部变量（8种基本数据类型、对象的引用地址）、部分结果，并参与方法的调用和返回。

局部变量：相对于成员变量（或属性）
基本数据变量： 相对于引用类型变量（类，数组，接口）

---
## 栈的特点

+ 栈是一种快速有效的分配存储方式，访问速度仅次于PC寄存器（程序计数器）
+ JVM直接对java栈的操作只有两个
    + 每个方法执行，伴随着进栈（入栈，压栈）
    + 执行结束后的出栈工作
+ 对于栈来说不存在垃圾回收问题

## 虚拟机栈可能出现的异常
+ StackOverFlowError
    + 递归调用，请求分配的栈容量超过 -Xss 分配的最大容量
+ OOM
    + 创建很多的线程，每个线程都会分配对应的虚拟机栈空间，内存不足时会抛出OOM

## 栈帧
+ 局部变量表
    + 时线程私有的数据，不存在线程不安全问题
    + 局部变量表的大小在编译期间就已经确定
    + 方法调用结束后，随着方法栈帧的销毁，局部变量表也会被销毁
    + 局部变量表中的变量也是重要的垃圾回收根节点，只要被局部变量表中直接或间接引用的对象都不会被回收
+ 操作数栈
    + 操作数栈的深度在编译期间已经确定
    + 如果被调用的方法带有返回值的话，其返回值将会被压入当前栈帧的操作数栈中，并更新PC寄存器中下一条需要执行的字节码指令。
    + 栈顶缓存技术，将栈顶元素缓存在CPU的寄存器中，降低堆内存的读写次数，提升执行效率
+ 动态链接
    + 在Java源文件被编译成字节码文件中时，所有的变量和方法引用都作为符号引用（symbolic Refenrence）保存在class文件的常量池里。比如：描述一个方法调用了另外的其他方法时，就是通过常量池中指向方法的符号引用来表示的，那么动态链接的作用就是为了将这些符号引用转换为调用方法的直接引用。
    + 虚方法表
+ 方法返回地址
    + 存放调用该方法的PC寄存器的值
+ 一些附加信息